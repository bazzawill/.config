!function FnClientSideEncryptionIIFE(){var u={};Okta.fn.clientSideEncryption=u;var y=Okta.Q,e=Okta._okta,s=e.constant,l=e.extend,n=e.map,d=e.mapObject,o=e.pick,g=e.values;function r(o,t,a,c){var p="FnClientSideEncryptionIIFE::processEncryptionDecryption: ";return function n(e){return e.getPluginSettings().then(function(e){return e&&e.orgSettings&&e.orgSettings.pluginClientSideEncryptionEnabled})}(t).then(function(e){if(!e)return Log.info(p+"client-side encryption feature is off. Returning credentials."),y(a);var r="",i=u.getClientSideEncryptionOptions().asymmetricKeyOptions;if(c===o.encrypt)r="publicKey",i.usage=["encrypt"];else{if(c!==o.decrypt)return y.reject(p+"invalid key type. Must be either privateKey or publicKey.");r="privateKey",i.usage=["decrypt"]}return function n(t,r,i,e){var o="Crypto::tryImportClientSideEncryptionKey: ";return e.getDataVaultKeyPair().then(function(e){if(!e){var n=o+"key not found in storage!";return Log.warn(n),y.reject(n)}if(!e.privateKey){n=o+"private key not found in storage!";return Log.warn(n),y.reject(n)}if(e.publicKey)return Log.info(o+"importing "+t),i.importKey(e[t],r);n=o+"public key not found in storage!";return Log.warn(n),y.reject(n)})}(r,i,o,t).then(function(n){var e=c===o.encrypt?"encrypting":"decrypting";Log.info(p+e+" credentials with "+r+".");var t=d(a,function(e,t){return e||(c=s(y(e))),c(n,e,i).then(function(e){var n={};return n[t]=e,n})});return y.all(g(t)).then(function(e){return l.apply(null,e)})})})}u.getClientSideEncryptionOptions=function(){return{symmetricKeyImportOptions:{exportedFormat:"raw",algorithm:"PBKDF2",isExtractable:!1,usage:["deriveKey"]},symmetricKeyDerivationOptions:{algorithm:{name:"PBKDF2",iterations:1e5,hash:"SHA-256"},derivedKeyAlgorithm:{name:"AES-GCM",length:256,usage:["encrypt","decrypt"]}},asymmetricKeyOptions:{exportedFormat:"jwk",algorithm:{name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},isExtractable:!0,usage:["encrypt","decrypt"]}}},u.encryptCredentials=function(e,n,t){return r(e,n,t,e.encrypt)},u.decryptCredentials=function(e,n,t){return r(e,n,t,e.decrypt)},u.decryptFormSitesApiResponse=function(t,r,e){var i="FnClientSideEncryptionIIFE::decryptFormSitesApiResponse: ";return e?e.errorCode?(Log.warn(i+"error in form sites response: "+JSON.stringify(e)),y(e)):y.all(n(e,function(n){var e=o(n,"username","password");return u.decryptCredentials(t,r,e).then(function(e){return l(n,e)})})).fail(function(e){var n=i+"could not decrypt response data: "+e;return Log.warn(n),y.reject(n)}):(Log.warn(i+"received no response"),y(e))}}();